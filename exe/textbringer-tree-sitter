#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"
require "open-uri"
require "rbconfig"
require "tmpdir"
require "open3"

module TextbringerTreeSitterCLI
  FAVEOD_VERSION = "v4.11"

  # Faveod tarball に含まれる parser
  FAVEOD_PARSERS = %w[
    bash c c-sharp cobol embedded-template groovy haml html
    java javascript json pascal php python ruby rust
  ].freeze

  # 要ビルド（Faveod に含まれない）
  BUILD_PARSERS = {
    hcl: {
      repo: "mitchellh/tree-sitter-hcl",
      branch: "main",
      build_cmd: ->(src_dir, out_file) {
        "c++ -shared -fPIC -O2 -std=c++14 -I#{src_dir}/src #{src_dir}/src/parser.c #{src_dir}/src/scanner.cc -o #{out_file}"
      }
    },
    yaml: {
      repo: "tree-sitter-grammars/tree-sitter-yaml",
      branch: "master",
      build_cmd: ->(src_dir, out_file) {
        "cc -shared -fPIC -O2 -I#{src_dir}/src #{src_dir}/src/parser.c #{src_dir}/src/scanner.c -o #{out_file}"
      }
    },
    go: {
      repo: "tree-sitter/tree-sitter-go",
      branch: "master",
      build_cmd: ->(src_dir, out_file) {
        "cc -shared -fPIC -O2 -I#{src_dir}/src #{src_dir}/src/parser.c -o #{out_file}"
      }
    },
    typescript: {
      repo: "tree-sitter/tree-sitter-typescript",
      branch: "master",
      subdir: "typescript",
      build_cmd: ->(src_dir, out_file) {
        "cc -shared -fPIC -O2 -I#{src_dir}/src #{src_dir}/src/parser.c #{src_dir}/src/scanner.c -o #{out_file}"
      }
    },
    tsx: {
      repo: "tree-sitter/tree-sitter-typescript",
      branch: "master",
      subdir: "tsx",
      build_cmd: ->(src_dir, out_file) {
        "cc -shared -fPIC -O2 -I#{src_dir}/src #{src_dir}/src/parser.c #{src_dir}/src/scanner.c -o #{out_file}"
      }
    },
    sql: {
      repo: "DerekStride/tree-sitter-sql",
      branch: "main",
      build_cmd: ->(src_dir, out_file) {
        "cc -shared -fPIC -O2 -I#{src_dir}/src #{src_dir}/src/parser.c #{src_dir}/src/scanner.c -o #{out_file}"
      }
    },
    markdown: {
      repo: "tree-sitter-grammars/tree-sitter-markdown",
      branch: "split_parser",
      subdir: "tree-sitter-markdown",
      build_cmd: ->(src_dir, out_file) {
        "cc -shared -fPIC -O2 -I#{src_dir}/src #{src_dir}/src/parser.c -o #{out_file}"
      }
    }
  }.freeze

  class << self
    def platform
      os = case RbConfig::CONFIG["host_os"]
           when /darwin/i then "darwin"
           when /linux/i then "linux"
           else "unknown"
           end

      arch = case RbConfig::CONFIG["host_cpu"]
             when /arm64|aarch64/i then "arm64"
             when /x86_64|amd64/i then "x64"
             else "unknown"
             end

      "#{os}-#{arch}"
    end

    def faveod_platform
      case platform
      when "darwin-arm64" then "macos-arm64"
      when "darwin-x64" then "macos-x64"
      when "linux-x64" then "linux-x64"
      when "linux-arm64" then "linux-arm64"
      else platform
      end
    end

    def dylib_ext
      case RbConfig::CONFIG["host_os"]
      when /darwin/i then ".dylib"
      else ".so"
      end
    end

    def parser_dir
      File.expand_path("~/.textbringer/parsers/#{platform}")
    end

    def parser_installed?(language)
      # c-sharp -> csharp の変換
      lang_name = language.to_s.gsub("-", "")
      filename = "libtree-sitter-#{language}#{dylib_ext}"
      File.exist?(File.join(parser_dir, filename))
    end

    def download_faveod_parser(language)
      # Faveod tarball から特定の parser をインストール
      filename = "libtree-sitter-#{language}#{dylib_ext}"
      dest_path = File.join(parser_dir, filename)

      if File.exist?(dest_path)
        puts "#{language}: already installed"
        return true
      end

      url = "https://github.com/Faveod/tree-sitter-parsers/releases/download/#{FAVEOD_VERSION}/tree-sitter-parsers-#{FAVEOD_VERSION.delete('v')}-#{faveod_platform}.tar.gz"

      puts "Downloading #{language} from Faveod..."

      Dir.mktmpdir do |tmpdir|
        tarball = File.join(tmpdir, "parsers.tar.gz")

        begin
          URI.open(url, "rb") do |remote|
            File.open(tarball, "wb") { |f| f.write(remote.read) }
          end
        rescue OpenURI::HTTPError => e
          puts "  Error: Failed to download: #{e.message}"
          return false
        end

        extract_dir = File.join(tmpdir, "extracted")
        FileUtils.mkdir_p(extract_dir)
        system("tar", "-xzf", tarball, "-C", extract_dir, out: File::NULL, err: File::NULL)

        src = Dir.glob("#{extract_dir}/**/#{filename}").first
        if src
          FileUtils.mkdir_p(parser_dir)
          FileUtils.cp(src, dest_path)
          FileUtils.chmod(0o755, dest_path)
          puts "  -> #{dest_path}"
          true
        else
          puts "  Error: #{language} not found in tarball"
          false
        end
      end
    end

    def build_parser(language)
      lang_sym = language.to_s.gsub("-", "_").to_sym
      info = BUILD_PARSERS[lang_sym]

      unless info
        puts "Error: Unknown build-required language: #{language}"
        puts "Available: #{BUILD_PARSERS.keys.join(', ')}"
        return false
      end

      filename = "libtree-sitter-#{language}#{dylib_ext}"
      dest_path = File.join(parser_dir, filename)

      if File.exist?(dest_path)
        puts "#{language}: already installed"
        return true
      end

      puts "Building #{language} parser..."
      puts "  Repository: #{info[:repo]}"

      Dir.mktmpdir do |tmpdir|
        repo_dir = File.join(tmpdir, "repo")

        puts "  Cloning..."
        _, status = Open3.capture2e("git", "clone", "--depth", "1", "-b", info[:branch],
                                    "https://github.com/#{info[:repo]}.git", repo_dir)
        unless status.success?
          puts "  Error: Failed to clone repository"
          return false
        end

        src_dir = info[:subdir] ? File.join(repo_dir, info[:subdir]) : repo_dir
        build_cmd = info[:build_cmd].call(src_dir, dest_path)

        puts "  Building..."
        FileUtils.mkdir_p(parser_dir)
        output, status = Open3.capture2e(build_cmd)

        unless status.success?
          puts "  Error: Build failed"
          puts output
          return false
        end

        FileUtils.chmod(0o755, dest_path)
        puts "  -> #{dest_path}"
        true
      end
    end

    def get_parser(language)
      lang = language.to_s

      # Faveod に含まれるか
      if FAVEOD_PARSERS.include?(lang)
        download_faveod_parser(lang)
      # ビルドが必要か
      elsif BUILD_PARSERS.key?(lang.gsub("-", "_").to_sym)
        build_parser(lang)
      else
        puts "Error: Unknown language: #{language}"
        puts ""
        puts "Faveod prebuilt: #{FAVEOD_PARSERS.join(', ')}"
        puts "Build required: #{BUILD_PARSERS.keys.join(', ')}"
        false
      end
    end

    def list_parsers
      puts "=== Faveod Prebuilt Parsers ==="
      FAVEOD_PARSERS.each do |lang|
        status = parser_installed?(lang) ? "✓" : " "
        puts "  [#{status}] #{lang}"
      end

      puts ""
      puts "=== Build-required Parsers ==="
      BUILD_PARSERS.keys.sort.each do |lang|
        status = parser_installed?(lang) ? "✓" : " "
        puts "  [#{status}] #{lang}"
      end

      puts ""
      puts "Use 'textbringer-tree-sitter get <lang>' to install"
    end

    def get_all
      puts "Installing all Faveod prebuilt parsers..."
      puts ""

      url = "https://github.com/Faveod/tree-sitter-parsers/releases/download/#{FAVEOD_VERSION}/tree-sitter-parsers-#{FAVEOD_VERSION.delete('v')}-#{faveod_platform}.tar.gz"

      puts "Downloading from Faveod..."
      puts "  URL: #{url}"

      Dir.mktmpdir do |tmpdir|
        tarball = File.join(tmpdir, "parsers.tar.gz")

        begin
          URI.open(url, "rb") do |remote|
            File.open(tarball, "wb") { |f| f.write(remote.read) }
          end
        rescue OpenURI::HTTPError => e
          puts "  Error: Failed to download: #{e.message}"
          return
        end

        extract_dir = File.join(tmpdir, "extracted")
        FileUtils.mkdir_p(extract_dir)
        system("tar", "-xzf", tarball, "-C", extract_dir, out: File::NULL, err: File::NULL)

        FileUtils.mkdir_p(parser_dir)

        Dir.glob("#{extract_dir}/**/libtree-sitter-*#{dylib_ext}").each do |src|
          filename = File.basename(src)
          dest = File.join(parser_dir, filename)

          if File.exist?(dest)
            puts "  #{filename} -> already installed"
          else
            FileUtils.cp(src, dest)
            FileUtils.chmod(0o755, dest)
            puts "  #{filename} -> OK"
          end
        end
      end

      puts ""
      puts "Done!"
    end

    def show_help
      puts <<~HELP
        textbringer-tree-sitter - Parser manager for textbringer-tree-sitter

        Usage:
          textbringer-tree-sitter list              List available parsers
          textbringer-tree-sitter get <lang>        Download/build a parser
          textbringer-tree-sitter get-all           Install all Faveod prebuilt parsers
          textbringer-tree-sitter path              Show parser directory

        Examples:
          textbringer-tree-sitter get hcl           Build and install HCL parser
          textbringer-tree-sitter get ruby          Download Ruby parser (Faveod)
          textbringer-tree-sitter get-all           Install all prebuilt parsers
          textbringer-tree-sitter list              Show all available parsers
      HELP
    end

    def run(args)
      command = args[0]

      case command
      when "list"
        list_parsers
      when "get"
        lang = args[1]
        if lang.nil?
          puts "Error: Please specify a language"
          puts "Usage: textbringer-tree-sitter get <lang>"
          exit 1
        end
        success = get_parser(lang)
        exit(success ? 0 : 1)
      when "get-all"
        get_all
      when "path"
        puts parser_dir
      when "help", "--help", "-h", nil
        show_help
      else
        puts "Unknown command: #{command}"
        show_help
        exit 1
      end
    end
  end
end

TextbringerTreeSitterCLI.run(ARGV)
